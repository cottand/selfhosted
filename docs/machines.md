# Machine Configuration with NixOS

The `machines/` directory contains NixOS configurations for all cluster nodes, managed via Colmena.

## Structure

```
machines/
├── _default/           # Common configuration for all machines
├── [machine-name]/     # Individual machine configurations
├── modules/           # Reusable NixOS modules
└── oci*/ gcp*/        # Cloud-specific configurations
```
## Common Configuration (`_default/`)

All machines inherit from:
- **common_config.nix** - Base system configuration
- **tailscale.nix** - Mesh networking setup

## Custom Modules (`modules/`)

### Core Services
- **consul.nix** - Service discovery configuration
- **nomad.nix** - Container orchestration setup
- **vault.nix** - Secret management
- **vaultSecret.nix** - Secret consumption utilities

### Networking
- **wireguard.nix** - VPN mesh networking

## Machine-Specific Features

### Nomad Configuration
Each Nomad node defines:
- Client/server role
- Host volumes for persistent storage  
- Network interfaces (Tailscale)
- SeaweedFS volume hosting capability

### Example Configuration
```nix
nomadNode = {
  enable = true;
  enableSeaweedFsVolume = true;
  hostVolumes = {
    "postgres-data" = {
      hostPath = "/var/lib/postgres";
      readOnly = false;
    };
  };
};
```

## Deployment with Colmena

### Deploy All Machines
```bash
colmena deploy
```

### Deploy Specific Machines
```bash
colmena deploy --on machine-name
```

### Deploy by Tags
```bash
colmena deploy --on @nomad-server
colmena deploy --on @germany
```

### Checking Status
```bash
colmena eval -E '{nodes, ...}: nodes.machine-name.config.system.build.toplevel'
```

## Hardware Configurations

Each machine has a `hardware-configuration.nix` generated by `nixos-generate-config` containing:
- Disk partitioning and filesystem mounts
- Kernel modules and boot configuration
- Hardware-specific settings

## Security

- All inter-node communication over Tailscale mesh
- Vault-managed PKI for service mTLS
- Automated secret rotation and distribution